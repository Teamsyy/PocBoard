# PocBoard - Enhanced Docker Management Makefile
# Provides easy commands for managing the Docker development environment

.PHONY: help dev prod logs clean status health restart build setup

# Default target
help: ## Show this help message
	@echo "PocBoard Docker Management Commands:"
	@echo "======================================"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "Quick Start: make setup && make dev"

setup: ## Initial setup for development environment
	@echo "ğŸ”§ Setting up PocBoard development environment..."
	@cp .env.template .env 2>/dev/null || echo "â„¹ï¸  .env already exists"
	@mkdir -p uploads/boards
	@echo "âœ… Environment setup complete!"
	@echo ""
	@echo "Next steps: run 'make dev' to start the application"

dev: ## Start development environment with all services
	@echo "ğŸš€ Starting PocBoard development environment..."
	@mkdir -p uploads/boards
	@docker-compose up -d postgres
	@echo "â³ Waiting for database to initialize..."
	@sleep 10
	@docker-compose up -d backend
	@echo "â³ Waiting for backend to be ready..."
	@sleep 15  
	@docker-compose up -d frontend
	@echo "âœ… Development environment started!"
	@echo ""
	@echo "ğŸŒ Access your application:"
	@echo "   Frontend:  http://localhost:3000"
	@echo "   Backend:   http://localhost:8080"
	@echo "   Health:    http://localhost:8080/health"

prod: ## Start production environment
	@echo "ğŸ­ Starting PocBoard production environment..."
	@docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
	@echo "âœ… Production environment started!"

stop: ## Stop all services
	@echo "ğŸ›‘ Stopping all services..."
	@docker-compose down
	@echo "âœ… All services stopped!"

restart: ## Restart all services
	@echo "ğŸ”„ Restarting all services..."
	@docker-compose restart
	@echo "âœ… All services restarted!"

logs: ## Show logs from all services (follow mode)
	@docker-compose logs -f

status: ## Show status of all services
	@echo "ğŸ“Š Service Status:"
	@echo "=================="
	@docker-compose ps

health: ## Check health of all services
	@echo "ğŸ¥ Health Check:"
	@echo "================"
	@echo "Backend Health:"
	@curl -s http://localhost:8080/health || echo "âŒ Backend not responding"
	@echo ""
	@echo "Frontend Health:"
	@curl -s -o /dev/null -w "%%{http_code}" http://localhost:3000 || echo "âŒ Frontend not responding"
	@echo ""

build: ## Rebuild all services
	@echo "ğŸ”¨ Building all services..."
	@docker-compose build
	@echo "âœ… Build complete!"

clean: ## Stop services and remove volumes (âš ï¸  DELETES ALL DATA)
	@echo "ğŸ§¹ WARNING: This will delete all data!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	@docker-compose down -v
	@docker system prune -f
	@echo "âœ… Cleanup complete!"

pgadmin: ## Start PgAdmin for database management
	@echo "ğŸ”§ Starting PgAdmin..."
	@docker-compose --profile tools up -d pgadmin
	@echo "âœ… PgAdmin available at http://localhost:8081"

# Aliases for convenience
up: dev ## Alias for dev
down: stop ## Alias for stop
